# PRD-007：语言底座（适配Trae开发）

## 1. 概述
- **目标用户**：所有需要多语言支持的模块（小程序、SaaS后台、硬件界面、营销系统）、翻译管理员、区域运营。
- **核心价值**：为全系统提供统一的、自动化的多语言适配能力，实现区域自动识别、动态内容本地化、语言包统一管理，确保全球用户体验一致。
- **技术目标**：构建区域识别服务、多语言资源中心、前端国际化框架、后端国际化服务、自动翻译引擎，支持7种以上语言，切换延迟≤100ms。

## 2. 用户故事
- 作为**海外用户**，我打开小程序时，系统自动根据我的IP显示当地语言，并且所有界面、支付页面、通知消息都使用同一种语言。
- 作为**门店店长**，我在后台配置门店信息时，可以设置门店的默认语言，新用户首次访问时优先使用该语言。
- 作为**翻译管理员**，我可以在后台更新语言包，上传新版本，系统自动同步到全球CDN，无需重启服务。
- 作为**营销专员**，我创建营销活动时，系统自动根据目标区域生成多语言文案，我只需要人工校准。
- 作为**开发人员**，我调用后端API时，只需要传入`Accept-Language`头，无需关心具体翻译实现。

## 3. 功能列表（按优先级）

### 3.1 区域识别服务（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| L01 | IP区域识别 | 根据用户IP地址判断所在国家/地区，返回语言代码和国家代码。 | MaxMind GeoIP2数据库，每日更新。 | 准确率≥99.9% |
| L02 | 浏览器语言识别 | 解析HTTP头`Accept-Language`，获取用户浏览器首选语言列表。 | 标准协议解析 | 准确率100% |
| L03 | 用户手动设置 | 用户可在前端手动切换语言，保存到账户偏好，覆盖自动识别。 | 接口：`POST /api/user/language` | 手动切换立即生效 |
| L04 | 门店默认语言 | 根据用户访问的门店，设置默认语言（如美国门店默认en-US）。 | 接口：`GET /api/store/{id}/language` | 匹配准确 |
| L05 | 综合决策引擎 | 综合IP、浏览器、手动设置、门店默认，按优先级确定最终语言。 | 规则引擎 | 决策逻辑清晰 |

### 3.2 多语言资源中心（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| L06 | 语言包存储 | 所有语言包以JSON格式存储，按语言代码命名（如`zh.json`、`en.json`），支持版本控制。 | Git仓库 + 数据库版本记录 | 历史版本可回滚 |
| L07 | 语言包上传 | 翻译管理员可通过后台上传新语言包或更新现有语言包，系统自动校验格式。 | 接口：`POST /api/i18n/upload` | 上传后10秒内生效 |
| L08 | CDN分发 | 语言包文件同步至全球CDN，前端按需加载，降低延迟。 | 阿里云CDN / CloudFlare | 边缘节点命中率≥90% |
| L09 | 热更新 | 语言包更新后，通过WebSocket推送通知前端重新加载，无需刷新页面。 | WebSocket + 本地缓存失效 | 切换延迟≤100ms |

### 3.3 前端国际化框架（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| L10 | 动态语言切换 | 前端根据当前语言代码，动态加载对应语言包，并更新所有界面文案。 | Vue I18n / React Intl | 切换无白屏 |
| L11 | 按需加载 | 首屏只加载基础语言包，其他页面按需加载，减少首屏体积。 | 动态import | 首屏加载时间≤2秒 |
| L12 | RTL支持 | 对于阿拉伯语等RTL语言，自动调整布局（左右翻转）。 | CSS逻辑属性 | 布局正确 |

### 3.4 后端国际化服务（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| L13 | 文案渲染API | 后端提供API，根据语言参数渲染动态文案（如邮件模板、短信模板）。 | Spring MessageSource + 自定义服务 | 响应≤50ms |
| L14 | 日期/数字/货币格式化 | 根据区域自动格式化日期、时间、数字、货币（如`$1,000.00` vs `￥1,000.00`）。 | Java `Locale` 或前端库 | 格式准确 |
| L15 | 变量替换 | 支持文案中的变量替换（如“您好，{name}”），防止XSS。 | 模板引擎 | 替换安全 |

### 3.5 自动翻译引擎（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| L16 | 机器翻译 | 对未覆盖的文案或AI生成内容进行实时机器翻译（备选人工校准）。 | 集成DeepL / Google Translate API | 翻译响应≤2秒 |
| L17 | 术语库 | 支持维护术语库（如品牌名“运动蚂蚁”固定翻译），确保专业名词一致性。 | 术语库管理后台 | 术语覆盖率≥95% |
| L18 | 人工校准 | 机器翻译结果可提交人工校准，校准后入库，下次直接使用。 | 工作流引擎 | 校准闭环 |

### 3.6 支付/网关本地化（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| L19 | 支付页面语言适配 | 调用支付SDK时传入语言参数，确保支付页面语言与系统一致。 | 支付中台扩展语言字段 | 支付页面语言匹配 |
| L20 | 短信/邮件网关适配 | 根据用户语言偏好选择对应短信服务商（国内/海外）和邮件模板语言版本。 | 消息网关服务集成语言参数 | 发送成功率≥99% |

### 3.7 管理后台功能（P2）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| L21 | 语言包管理界面 | 提供语言包列表、上传、下载、版本对比功能。 | Vue + 文件上传 | 操作友好 |
| L22 | 翻译工作量统计 | 统计各语言包完成度、翻译进度、人工校准需求。 | 报表 | 数据清晰 |
| L23 | 门店默认语言配置 | 总部可为每个门店设置默认语言，新用户首次访问时使用。 | 接口：`PUT /api/stores/{id}/language` | 配置实时生效 |

## 4. 技术架构
- **区域识别**：MaxMind GeoIP2 + 自研决策引擎（Spring Boot）。
- **资源中心**：Git（存储）+ 数据库（版本） + CDN（分发）。
- **前端**：Vue I18n / React Intl + WebSocket客户端。
- **后端**：Spring MessageSource + 自定义LocaleResolver + 翻译服务（DeepL/Google）。
- **管理后台**：Vue + Element Plus，对接上传接口。
- **底座依赖**：
  - AI底座：自动翻译可能调用AI内容生成引擎。
  - 通讯社媒底座：多语言推送通知。

## 5. 接口设计示例
- **区域识别接口**：
  - `GET /api/locale/detect`
  - 请求头：`X-Forwarded-For`（IP），`Accept-Language`
  - 响应：
    ```json
    {
      "lang": "zh-CN",
      "country": "CN",
      "currency": "CNY"
    }
    ```

- **语言包获取接口**：
  - `GET /api/i18n/{lang}.json`
  - 响应：JSON语言包内容。
  - 缓存：CDN缓存，ETag支持。

- **翻译接口**（内部调用）：
  - `POST /api/i18n/translate`
  - 请求：
    ```json
    {
      "text": "欢迎光临",
      "targetLang": "en",
      "sourceLang": "zh"
    }
    ```
  - 响应：
    ```json
    {
      "translatedText": "Welcome"
    }
    ```

## 6. 验收标准
- 区域识别准确率≥99.99%（基于测试IP集）。
- 语言切换生效延迟≤100ms（含CDN缓存刷新）。
- 静态语言包覆盖所有界面元素，覆盖率100%。
- 动态内容翻译准确率（人工校准后）≥98%。
- 支持同时在线语言版本≥7种。
- 语言包更新后，全网10秒内生效。
- 符合GDPR/等保2.0：不存储用户IP与语言的关联记录（除非用户手动设置）。

## 7. 依赖模块
- **AI底座**：用于自动翻译的备选引擎（可选）。
- **通讯社媒底座**：用于多语言推送通知。
- **用户中心**：存储用户手动设置的语言偏好。

---
**版本历史**：
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2025-03-02 | 初始版本，基于总体规划文档 | 产品团队 |