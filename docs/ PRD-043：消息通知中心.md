# PRD-043：消息通知中心（适配Trae开发）

## 1. 概述
- **目标用户**：系统管理员、运营人员、所有需要接收通知的用户（员工、顾客）。
- **核心价值**：构建统一的消息通知平台，整合短信、邮件、小程序订阅消息、企微/钉钉/飞书、App推送等渠道，提供模板管理、发送策略、送达统计、历史存档，确保重要通知及时触达，提升用户沟通效率。
- **技术目标**：基于Spring Boot + Kafka + 多渠道SDK，支持消息模板化、优先级队列、重试机制、渠道智能路由，消息送达率≥99.9%。

## 2. 用户故事
- 作为**运营人员**，我想要创建一个新活动通知，选择合适的模板，设定发送人群（如“所有会员”），系统自动通过小程序消息、短信多渠道推送，并实时查看送达率。
- 作为**系统管理员**，我需要监控各渠道发送量、失败率，配置渠道优先级（如优先用免费小程序消息，失败后降级为短信）。
- 作为**顾客**，我收到一条预约成功的短信，同时在小程序里也看到消息通知。

## 3. 功能列表（按优先级）

### 3.1 消息模板管理（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| NC01 | 模板类型配置 | 支持多种模板类型（验证码、通知、营销），不同渠道可单独配置模板ID。 | 接口：`/api/notify/templates` | 配置灵活 |
| NC02 | 模板编辑 | 可视化编辑模板内容，支持变量占位符（如{name}），预览效果。 | 模板引擎 | 编辑便捷 |
| NC03 | 多语言模板 | 同一模板可配置多语言版本，根据用户语言自动选择。 | 语言底座集成 | 切换准确 |

### 3.2 消息发送（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| NC04 | 单发/群发 | 支持单用户发送和批量群发，群发任务可拆分异步处理。 | 接口：`POST /api/notify/send` | 发送成功 |
| NC05 | 渠道智能路由 | 根据用户设置、消息优先级、渠道成本，自动选择最优渠道（如优先小程序，未关注则短信）。 | 规则引擎 | 路由合理 |
| NC06 | 发送重试 | 发送失败自动重试（3次，间隔递增），最终失败进入死信队列人工处理。 | 消息队列 + 重试机制 | 重试机制生效 |
| NC07 | 频率限制 | 对同一用户同一类型消息设置发送频率（如验证码60秒一次），防止轰炸。 | Redis计数 | 限制准确 |

### 3.3 送达统计与监控（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| NC08 | 实时看板 | 展示今日发送总量、成功率、各渠道占比、失败趋势。 | 数据中台 | 刷新≤5秒 |
| NC09 | 发送记录 | 可查询每条消息的发送状态（成功/失败/已读），失败原因。 | Elasticsearch | 查询≤3秒 |
| NC10 | 渠道健康度 | 监控各渠道接口响应时间、成功率，异常自动告警。 | 监控服务 | 告警及时 |

### 3.4 用户订阅管理（P2）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| NC11 | 通知中心 | 用户可在小程序设置中管理通知类型（如活动通知、订单通知），开启/关闭。 | 接口：`/api/notify/preferences` | 设置生效 |
| NC12 | 免打扰时段 | 支持用户设置免打扰时段，期间不发送非紧急通知。 | 规则引擎 | 屏蔽准确 |

## 4. 技术架构
- **前端**：Vue3后台、小程序SDK。
- **后端**：Spring Boot + Kafka + 多渠道适配器。
- **数据**：MySQL（模板）、Redis（计数）、Elasticsearch（日志）。
- **底座依赖**：
  - 语言底座：多语言模板。
  - 数据中台：统计。
  - 各业务模块：消息来源。

## 5. 接口设计示例
- **发送验证码**：
  - `POST /api/notify/send`
  - 请求：
    ```json
    {
      "userId": 12345,
      "templateCode": "verify_code",
      "params": { "code": "123456" },
      "channels": ["sms", "weapp"]
    }
    ```

## 6. 验收标准
- 模板创建生效。
- 发送成功率≥99.9%。
- 频率限制准确。
- 看板数据实时。

## 7. 依赖模块
- **语言底座**：多语言。
- **数据中台**：统计。
- **各业务模块**：触发消息。

---
**版本历史**：
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2025-03-03 | 初始版本 | 产品团队 |