# PRD-080：系统操作日志审计（适配Trae开发）

## 1. 概述
- **目标用户**：安全审计员、系统管理员、合规官。
- **核心价值**：全面记录用户和系统的关键操作日志，支持多维检索、回放、告警，满足合规审计要求，提供不可篡改的审计证据。
- **技术目标**：基于AOP + Elasticsearch + 区块链存证，日志收集延迟≤5秒，存储周期≥1年（核心日志10年）。

## 2. 用户故事
- 作为**安全审计员**，我需要查询某用户在过去一个月内的所有敏感操作（如删除订单、修改权限），导出审计报告。
- 作为**系统管理员**，当发生安全事件时，我可以快速回放事件发生前后的操作记录。

## 3. 功能列表（按优先级）

### 3.1 日志采集（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| AL01 | 操作日志记录 | 通过AOP自动记录用户操作（类、方法、参数、结果、耗时、IP、UserAgent）。 | 自定义注解 + AOP | 覆盖核心操作 |
| AL02 | 登录日志 | 记录所有登录尝试（成功/失败）、登出、会话超时。 | Spring Security集成 | 完整记录 |

### 3.2 日志存储（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| AL03 | 结构化存储 | 日志以JSON格式存储到Elasticsearch，便于检索。 | Logstash | 索引清晰 |
| AL04 | 冷热分离 | 近期日志存储热节点，历史日志自动迁移至冷存储（OSS）。 | 数据生命周期管理 | 成本可控 |

### 3.3 日志查询与审计（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| AL05 | 多维检索 | 支持按时间、用户、模块、操作类型、IP、结果等条件组合查询。 | Kibana/自研UI | 响应≤3秒 |
| AL06 | 操作回放 | 按时间顺序展示某个用户/某个业务单号的操作轨迹。 | 接口：`GET /api/audit/trace` | 轨迹清晰 |
| AL07 | 审计报告导出 | 导出查询结果为Excel/PDF，包含操作人、时间、详情。 | 导出服务 | 导出成功 |

### 3.4 存证与防篡改（P2）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| AL08 | 区块链存证 | 对关键操作日志计算哈希，定期上链，提供存证验证入口。 | 区块链集成 | 可验证 |

## 4. 依赖模块
- 数据中台（PRD-011）
- 系统管理（PRD-018）

---
**版本历史**：V1.0 2025-03-03