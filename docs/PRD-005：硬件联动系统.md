# PRD-005：硬件联动系统（适配Trae开发）

## 1. 概述
- **目标用户**：门店技术员、技术主管、安监机修、店长、值班经理。
- **核心价值**：实现门店所有智能硬件（核销终端、人脸识别闸机、VR设备、游戏机台、环境监测设备等）的统一接入、实时监控、远程控制、故障预警与维修工单闭环，保障设备完好率≥95%，提升顾客体验。
- **技术目标**：基于MQTT/TCP/IP/HTTP等多协议接入，通过硬件联动网关统一管理，与AI底座（预测性维护）、财务底座（备件成本）、通讯社媒底座（告警通知）深度集成。

## 2. 用户故事
- 作为**技术员**，我想要实时查看全场设备运行状态，接收故障告警，快速处理维修工单，记录维修日志，查询备件库存。
- 作为**技术主管**，我想要制定巡检计划，分析设备故障率，控制备件成本，培训新人，接收AI推送的预防性维护建议。
- 作为**安监机修**，我想要接收安全巡检任务，处理突发事件，记录事故报告，管理消防设施。
- 作为**店长**，我想要监控设备健康度，了解故障对运营的影响，审批备件采购。
- 作为**值班经理**，我想要在高峰期快速协调技术员处理设备问题，减少顾客等待。

## 3. 功能列表（按优先级）

### 3.1 设备接入与注册（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H01 | 多协议设备接入 | 支持MQTT、TCP/IP、HTTP/HTTPS、FTP、蓝牙等协议设备统一接入，提供设备SDK或对接文档。 | 硬件联动网关，协议适配器模式。 | 新设备接入≤2人日 |
| H02 | 设备自动发现 | 支持同一局域网内设备自动发现（广播/UDP），一键添加。 | 接口：`POST /api/devices/discover` | 发现准确率≥95% |
| H03 | 手动设备注册 | 手动输入设备编号、IP地址、设备类型，测试连接后保存。 | 接口：`POST /api/devices/register` | 注册成功响应≤2秒 |
| H04 | 设备信息管理 | 维护设备基础信息（型号、位置、购买日期、保修期、固件版本），支持批量导入。 | 接口：`/api/devices` | 信息完整可查 |

### 3.2 实时监控与状态看板（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H05 | 全局设备状态看板 | 以图表形式展示全场设备在线/离线/故障数量，各区域设备状态分布，实时刷新。 | WebSocket推送，接口：`GET /api/devices/overview` | 数据刷新≤2秒 |
| H06 | 设备详情监控 | 查看单个设备实时状态（运行参数、故障代码、网络延迟），支持历史数据趋势图。 | 接口：`GET /api/devices/{id}/status` | 历史数据可追溯 |
| H07 | 异常告警 | 设备离线、故障、参数超限时自动告警，通过通讯社媒底座推送至相关人员（企微/短信/邮件）。 | 规则引擎+消息推送 | 告警延迟≤5秒 |

### 3.3 远程控制与配置（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H08 | 远程启停 | 支持远程启动、关闭、重启设备（如VR设备预热、闸机开关）。 | 接口：`POST /api/devices/{id}/control`，指令下发。 | 控制响应≤3秒 |
| H09 | 参数配置 | 远程调整设备参数（如人脸识别阈值、核销终端音量、游戏机难度）。 | 接口：`POST /api/devices/{id}/config` | 配置实时生效 |
| H10 | 固件升级 | 支持固件远程推送升级，升级前备份配置，失败自动回滚。 | 接口：`POST /api/devices/{id}/firmware` | 升级成功率≥99% |

### 3.4 故障与维修管理（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H11 | 故障自动报修 | 设备故障时自动生成维修工单（含故障代码、时间、位置），分配给对应技术员。 | 规则引擎，工单系统。 | 工单生成≤10秒 |
| H12 | 手动报修 | 员工通过工作台或扫码提交故障报修，上传照片、描述问题。 | 接口：`POST /api/workorders` | 工单自动流转 |
| H13 | 工单处理 | 技术员接收工单，现场维修后填写维修记录（故障原因、处理措施、更换备件），上传维修前后照片。 | 接口：`POST /api/workorders/{id}/process` | 记录完整 |
| H14 | 工单看板 | 按状态（待处理、处理中、已完成）展示工单列表，支持筛选、导出。 | 接口：`GET /api/workorders` | 实时更新 |
| H15 | 维修知识库 | 积累常见故障及处理方案，支持技术员查询、贡献。 | 接口：`/api/knowledgebase` | 内容可检索 |

### 3.5 巡检与预防性维护（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H16 | 巡检计划制定 | 支持制定日/周/月巡检计划，分配巡检区域、设备、责任人，设置提醒。 | 接口：`POST /api/inspections/plan` | 计划自动提醒 |
| H17 | 巡检执行 | 巡检人员按计划逐项检查，扫码确认，上传状态照片，填写异常记录。 | 接口：`POST /api/inspections/execute` | 巡检记录完整 |
| H18 | 预防性维护 | AI底座基于设备运行数据（运行时长、故障次数）预测故障风险，推送保养建议，生成保养工单。 | AI模型+规则引擎 | 预测准确率≥80% |

### 3.6 备件管理（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H19 | 备件库存管理 | 管理备件入库、出库、库存预警（低于安全库存自动提醒）。 | 接口：`/api/spareparts` | 库存实时准确 |
| H20 | 备件申领 | 技术员在维修时发起备件申领，关联工单，审批后出库。 | 工作流引擎 | 申领流程闭环 |
| H21 | 备件成本统计 | 统计各设备备件消耗成本，辅助采购决策。 | 财务底座接口 | 数据准确 |

### 3.7 离线与边缘自治（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H22 | 离线模式 | 网络中断时，核销终端、闸机等支持本地缓存数据，联网后自动同步。 | 本地数据库，冲突处理策略（以云端为准）。 | 数据不丢失，同步完整 |
| H23 | 边缘计算 | 部分设备（如人脸识别闸机）支持边缘端处理，减少云端依赖。 | 边缘节点部署 | 处理延迟≤1秒 |

### 3.8 数据统计与报表（P2）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| H24 | 设备完好率报表 | 按月统计设备完好率、平均修复时间（MTTR）、平均故障间隔（MTBF），生成趋势图。 | 接口：`GET /api/devices/reports` | 报表自动生成 |
| H25 | 故障分析 | 分析故障类型分布、高频故障设备，提供优化建议。 | AI底座分析 | 建议可采纳 |

## 4. 技术架构
- **接入层**：硬件联动网关，支持MQTT、TCP/IP、HTTP/HTTPS、FTP、蓝牙等多协议。
- **核心服务**：
  - 设备管理服务：设备注册、状态监控、远程控制。
  - 工单服务：故障报修、维修流程、知识库。
  - 巡检服务：计划制定、执行记录。
  - 备件服务：库存管理、申领审批。
- **数据**：MySQL（设备信息、工单、巡检）、Redis（实时状态）、InfluxDB（时序数据）、Elasticsearch（日志）。
- **底座依赖**：
  - AI底座：预测性维护、故障分析。
  - 通讯社媒底座：告警通知（企微/短信/邮件）。
  - 财务底座：备件成本、采购审批。

## 5. 接口设计示例
- **设备状态上报接口**（设备端调用）：
  - `POST /api/devices/{deviceId}/status`
  - 请求：
    ```json
    {
      "timestamp": "2025-03-02T10:30:00Z",
      "status": "online",
      "faultCode": null,
      "parameters": {
        "temperature": 45.2,
        "rpm": 3000
      }
    }
    ```
  - 响应：`{ "code": 200 }`

- **创建维修工单接口**：
  - `POST /api/workorders`
  - 请求：
    ```json
    {
      "deviceId": 2001,
      "reportedBy": 301,
      "faultDesc": "屏幕不亮",
      "photos": ["url1", "url2"]
    }
    ```
  - 响应：`{ "workOrderId": 5001, "assignedTo": 302 }`

## 6. 验收标准
- 设备状态监控实时刷新（延迟≤2秒）。
- 故障告警推送成功率≥99.9%。
- 工单处理流程闭环，维修记录完整。
- 预防性维护建议准确率≥80%。
- 备件库存预警准确。
- 符合安全要求：设备通信加密，权限控制严格。

## 7. 依赖模块
- **AI底座**：预防性维护、故障分析。
- **通讯社媒底座**：告警通知。
- **财务底座**：备件成本、采购审批。
- **岗位工作台**：技术员、技术主管工单处理界面。

---
**版本历史**：
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2025-03-02 | 初始版本，基于总体规划文档及硬件资料 | 产品团队 |