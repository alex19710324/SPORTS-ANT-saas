# PRD-042：智能寄存柜管理（适配Trae开发）

## 1. 概述
- **目标用户**：顾客、前台、技术员、店长。
- **核心价值**：提供便捷的自助寄存服务，支持扫码开柜、临时存取、超时收费、远程开锁，解放人力，提升顾客体验。
- **技术目标**：基于物联网通信（MQTT）+ Spring Boot微服务，与智能柜硬件联动，支持远程控制、实时状态监控、计费结算，柜门开锁成功率≥99.9%。

## 2. 用户故事
- 作为**顾客**，我到店后扫一扫柜身上的二维码，选择“存包”，支付押金/租金，柜门弹开，存入物品。游玩结束后扫码取包，超时自动扣费。
- 作为**前台**，遇到顾客忘记取物或柜门故障，可在后台远程开柜，帮顾客取回物品。
- 作为**店长**，我想要查看柜子使用率、收入情况，优化柜子数量和位置。

## 3. 功能列表（按优先级）

### 3.1 柜体管理（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| LB01 | 柜体配置 | 管理柜组、柜门编号，设置位置（如入口、更衣区）、规格（小/中/大）、收费标准。 | 接口：`/api/locker/cabinets` | 配置灵活 |
| LB02 | 状态监控 | 实时监控每个柜门状态（空闲/占用/故障），心跳上报。 | MQTT通信 | 刷新≤5秒 |
| LB03 | 故障上报 | 柜门异常自动告警（如长时间未关、硬件故障），通知技术员。 | 告警规则 | 告警及时 |

### 3.2 用户存包流程（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| LB04 | 扫码开柜 | 用户扫描柜门二维码，选择“存包”，系统分配空闲柜门，用户支付后开锁。 | 接口：`POST /api/locker/open` | 开锁成功率≥99.9% |
| LB05 | 支付方式 | 支持押金+免费时段（如前2小时免费）、按时计费（超出扣费）、会员免费等模式。 | 支付网关 | 支付灵活 |
| LB06 | 取包 | 用户扫码，系统验证身份（通过手机号/订单号），计算费用（如有），支付后开锁。 | 接口：`POST /api/locker/close` | 取包成功 |

### 3.3 后台管理（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| LB07 | 远程开柜 | 前台在后台可手动打开任意柜门（需授权），记录操作日志。 | 接口：`POST /api/locker/admin/open` | 开锁成功 |
| LB08 | 超时处理 | 超时未取物品，系统通知顾客，可转存至失物招领。 | 定时任务 | 处理闭环 |
| LB09 | 收入统计 | 统计寄存收入、使用率、峰值时段。 | 数据中台 | 报表清晰 |

### 3.4 安全与审计（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| LB10 | 操作日志 | 记录所有开柜记录（用户ID、时间、柜号、操作人）。 | 审计日志 | 可追溯 |
| LB11 | 异常监控 | 监控频繁开柜失败、长时间占用等异常，自动预警。 | 规则引擎 | 预警准确 |

## 4. 技术架构
- **硬件通信**：MQTT Broker（EMQX）。
- **后端**：Spring Boot + 寄存柜微服务。
- **数据**：MySQL（柜体、订单）、Redis（状态）、Elasticsearch（日志）。
- **底座依赖**：
  - 支付网关：计费。
  - 数据中台：分析。

## 5. 接口设计示例
- **用户开柜请求**：
  - `POST /api/locker/open`
  - 请求：
    ```json
    {
      "cabinetCode": "A01",
      "userId": 12345,
      "action": "store"
    }
    ```
  - 响应：`{ "lockerNo": "A01-05", "openResult": "success" }`

## 6. 验收标准
- 开锁成功率≥99.9%。
- 计费准确无误。
- 远程开柜有日志记录。
- 实时状态同步≤5秒。

## 7. 依赖模块
- **支付网关**：计费。
- **数据中台**：分析。
- **硬件联动网关**：MQTT通信。

---
**版本历史**：
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2025-03-03 | 初始版本 | 产品团队 |