# PRD-030：团购与OTA平台对接管理（适配Trae开发）

## 1. 概述
- **目标用户**：市场专员、门店收银员、财务人员、总部运营。
- **核心价值**：实现与美团、抖音、大众点评等主流团购/OTA平台的无缝对接，支持团购券的自动生成、核销、数据同步、对账结算，提升线上引流效率，降低人工操作错误率。
- **技术目标**：基于Spring Boot微服务架构，集成各平台开放API，构建统一对接网关，实现券码管理、核销验证、数据回传、财务报表自动生成，核销成功率≥99.99%。

## 2. 用户故事
- 作为**市场专员**，我想要在后台配置一次团购活动（如“49.9元通玩券”），系统自动生成团购券模板并分发至各平台，活动结束后自动统计核销数据。
- 作为**收银员**，顾客出示团购券二维码时，我扫码即可完成核销，系统自动验证券的有效性，无需人工输入。
- 作为**财务人员**，我想要每月自动拉取各平台对账单，与系统核销记录比对，快速完成对账结算。
- 作为**店长**，我想要查看各团购渠道带来的客流、核销率、客单价，评估活动效果。

## 3. 功能列表（按优先级）

### 3.1 平台接入与管理（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| TG01 | 平台账号配置 | 支持配置美团、抖音、大众点评等平台的开放平台账号信息（AppKey、Secret、店铺ID）。 | 接口：`/api/ota/accounts` | 配置保存成功 |
| TG02 | 平台商品映射 | 将系统内项目（如蹦床、VR）映射到各平台的商品ID，支持一对多映射。 | 规则配置 | 映射准确 |
| TG03 | 平台接口监控 | 实时监控各平台接口调用状态，异常时告警。 | 监控看板 | 告警及时 |

### 3.2 团购券管理（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| TG04 | 券码生成 | 系统自动生成唯一券码（支持QR码/条码），与平台订单关联。 | 券码服务 | 无重复 |
| TG05 | 券生命周期管理 | 跟踪券的状态（待核销、已核销、已退款、已过期），状态变更时同步至平台。 | 状态机 | 状态准确 |
| TG06 | 券码导出 | 支持批量导出券码（用于实体券印刷）。 | 导出服务 | 导出≤10秒 |

### 3.3 核销验证（P0）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| TG07 | 扫码核销 | 收银员通过POS机/扫码枪扫描顾客团购券二维码，系统调用平台接口验证券有效性，返回核销结果。 | 接口：`POST /api/ota/verify` | 响应≤1秒 |
| TG08 | 离线核销 | 网络中断时，支持本地缓存券码信息，联网后自动同步核销记录。 | 本地缓存 + 定时同步 | 数据不丢失 |
| TG09 | 退款处理 | 平台发起退款时，系统自动更新券状态，并通知门店。 | 回调处理 | 状态同步 |

### 3.4 数据同步与对账（P1）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| TG10 | 订单自动拉取 | 定时从各平台拉取订单数据（新订单、退款订单），生成内部订单。 | 定时任务 | 延迟≤5分钟 |
| TG11 | 核销数据回传 | 核销成功后，实时回传核销状态至平台，更新平台订单状态。 | 回调接口 | 成功率≥99% |
| TG12 | 自动对账 | 每日自动拉取平台对账单，与内部核销记录逐笔比对，生成对账差异报告。 | 对账引擎 | 对账自动化率≥98% |
| TG13 | 结算单生成 | 根据对账结果生成应付/应收结算单，推送至财务底座。 | 财务接口 | 准确无误 |

### 3.5 活动效果分析（P2）

| ID | 功能名称 | 描述 | 技术实现要点 | 验收标准 |
|----|----------|------|--------------|----------|
| TG14 | 渠道引流看板 | 展示各平台带来的订单数、核销数、核销率、客单价、总营收。 | 数据中台 | 实时刷新 |
| TG15 | 活动对比分析 | 支持对比不同团购活动的效果，帮助优化投放策略。 | 报表引擎 | 分析清晰 |

## 4. 技术架构
- **前端**：Vue3 + Element Plus（后台）。
- **后端**：Spring Boot + 团购网关服务。
- **数据**：MySQL（券码、订单）、Redis（缓存核销状态）。
- **底座依赖**：
  - 财务底座：结算单。
  - 数据中台：效果分析。
  - 通讯社媒底座：告警通知。

## 5. 接口设计示例
- **核销验证接口**：
  - `POST /api/ota/verify`
  - 请求：
    ```json
    {
      "code": "1234567890",
      "platform": "meituan",
      "storeId": 1001
    }
    ```
  - 响应：
    ```json
    {
      "code": 200,
      "data": {
        "valid": true,
        "orderId": "MT12345",
        "productName": "蹦床1小时券",
        "expireTime": "2025-12-31"
      }
    }
    ```

## 6. 验收标准
- 券码生成无重复。
- 核销响应≤1秒。
- 对账差异率≤0.1%。
- 与平台数据同步延迟≤5分钟。

## 7. 依赖模块
- **财务底座**：结算。
- **数据中台**：分析。
- **通讯社媒底座**：告警。

---
**版本历史**：
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2025-03-03 | 初始版本，团购与OTA平台对接管理 | 产品团队 |