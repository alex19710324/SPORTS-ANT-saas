name: Deploy to Test Environment

on:
  push:
    branches: [ "develop" ]
  workflow_dispatch:

jobs:
  build-and-test-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      run: mvn -B package --file backend/pom.xml -DskipTests
      
    - name: Run Backend Tests
      run: mvn -B test --file backend/pom.xml

  build-and-test-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Run Lint
      working-directory: ./frontend
      run: npm run lint
      continue-on-error: true # Allow lint warnings for now
      
    - name: Run Unit Tests
      working-directory: ./frontend
      run: npm run test:unit
      
    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build

  deploy-test:
    needs: [build-and-test-backend, build-and-test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Deploy to Test Server
        run: |
          echo "Deploying to Test Environment..."
          # Add your deployment script here (e.g., SSH, SCP, Docker Push)
          # Example: ssh user@test-server "cd /app && docker-compose pull && docker-compose up -d"
          echo "Deployment Completed Successfully!"
